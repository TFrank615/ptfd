<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PTFD Dashboard</title>
  <link rel="icon" type="image/x-icon" href="./assets/256.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
  
  <!-- PapaParse and Day.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.11/dayjs.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .feather { width: 1em; height: 1em; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    
    /* Animation classes */
    .feed-item {
        opacity: 0;
        transform: translateY(2rem); 
        transition: opacity 0.8s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .feed-item.active { opacity: 1; transform: translateY(0); }
    .feed-item.fading-out { opacity: 0; transform: translateY(-2rem); }

    /* Ticker Animation */
    @keyframes marquee {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-100%); }
    }
    .animate-marquee { animation: marquee 20s linear infinite; }
    .ticker-hidden { display: none; }
    .ticker-visible { display: flex; }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen w-full overflow-hidden cursor-none">

  <!-- Main content area -->
  <div class="flex-grow flex flex-col md:flex-row min-h-0 transition-all duration-500 ease-in-out" id="main-content-area">
    <!-- Toolbar / Sidebar -->
    <aside class="w-full md:w-64 bg-gray-800 text-white flex md:flex-col justify-around md:justify-between items-center p-4 md:p-5 flex-shrink-0 z-20 shadow-lg">
      <div class="flex flex-col items-center text-center">
        <img id="dashboard-logo" src="logo.png" alt="Logo" class="w-40 md:w-60 h-auto rounded-lg" onerror="this.style.display='none'">
      </div>

      <!-- Weather Widget -->
      <div id="toolbar-weather-widget" class="text-center">
          <div id="weather-icon-container" class="w-24 h-24 mx-auto mb-2 flex items-center justify-center">
              <i data-feather="loader" class="animate-spin text-blue-300 w-16 h-16"></i>
          </div>
          <p id="weather-temp" class="text-6xl font-black">--°</p>
          <p id="weather-condition" class="text-2xl text-gray-300 mt-2">Loading...</p>
          <p id="weather-location" class="text-xl font-bold mt-2">...</p>
          <p id="weather-high-low" class="text-md text-gray-400">H: --° L: --°</p>
      </div>
      
      <!-- Sidebar Alert Display -->
      <div id="sidebar-alert-display" class="w-full hidden px-2 my-2 transition-all duration-300"></div>
      
      <!-- Clock -->
      <div id="clock-container" class="w-48 md:w-full h-20 transition-all duration-300 ease-in-out">
          <iframe title="Time and Date Clock" src="https://free.timeanddate.com/clock/ia164w8b/n805/fn2/fs30/fcfff/tct/pct/ftb/pb5/tt0/tw0/tm1/th1/tb4" frameborder="0" class="w-full h-full" allowtransparency="true"></iframe>
      </div>
    </aside>

    <!-- Main Content Slides -->
    <main class="flex-grow relative min-h-0">
      <div class="slides" id="slidesContainer">
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
      </div>
    </main>
  </div>

  <!-- IPAWS / NWS Alert Overlay -->
  <div id="ipawsAlertOverlay" class="fixed inset-0 bg-black bg-opacity-95 text-red-500 text-3xl md:text-5xl font-black flex justify-center items-center text-center z-[9999] p-5 leading-tight opacity-0 invisible transition-opacity duration-500"></div>
  
  <!-- Ticker Bar -->
  <div id="ticker-bar" class="w-full h-20 bg-red-900 border-t-4 border-red-700 flex-shrink-0 z-50 hidden items-center overflow-hidden shadow-2xl relative">
      <div id="ticker-content" class="whitespace-nowrap text-4xl font-bold text-white uppercase tracking-wider px-4"></div>
  </div>

  <audio id="alertSound"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, deleteDoc, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
 
    document.addEventListener('DOMContentLoaded', async () => {

        // --- UPDATED FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyAEELEzdEeTgidrSjThsTH2-uDPnFindb0",
          authDomain: "pleasant-township-48aa9.firebaseapp.com",
          projectId: "pleasant-township-48aa9",
          storageBucket: "pleasant-township-48aa9.firebasestorage.app",
          messagingSenderId: "859989513428",
          appId: "1:859989513428:web:097a276b3ed90d80e35741",
          measurementId: "G-V3HNW1E3S4"
        };

        // --- PATH HELPER ---
        const APP_ID = firebaseConfig.appId;
        const getPath = (colName) => `artifacts/${APP_ID}/public/data/${colName}`;

        let db, auth;
        let dashboardConfig = null;
        let slideSources = [];
        const shownAlerts = new Set();
        
        // Intervals
        let ipawsInterval = null, weatherInterval = null, slidesRefreshInterval = null, slideRotationTimer = null, tickerInterval = null, newsFeedSlideInterval = null;

        // Slide state
        const slideDivs = document.querySelectorAll('.slide');
        let contentIndex = 0, activeSlideIndex = 0;
        
        // Special Slides
        const googleSlideSource = { type: 'googleslides', iframe: ``, duration: 20000, order: 1 };
        const newsFeedSlideSource = {
            type: 'newsfeed',
            iframe: `<div id="feed-container" class="relative w-full h-full overflow-hidden bg-gradient-to-br from-gray-900 to-gray-800 text-white font-sans"><div id="feed-track" class="absolute top-0 left-0 w-full h-full"></div></div>`,
            duration: 60000, 
            order: 2 
        };
        let newsFeedPosts = [];
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFwKf1UaKCKLASXnjnKprBD_dUoNxfj2ypNjC5x_vAzO6AmNJagIe86-uTkvGs_2xsXUthRDydbayG/pub?gid=248750333&single=true&output=csv';
        const REFRESH_INTERVAL_MS = 600000; 

        // ------------------------------
        // Ticker Logic
        // ------------------------------
        function initializeTicker() {
            // *** PATH UPDATED ***
            const tickerRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'ticker');
            
            onSnapshot(tickerRef, (snapshot) => {
                const allMessages = [];
                snapshot.forEach(doc => allMessages.push(doc.data()));
                
                const checkTicker = () => {
                    if (typeof dayjs === 'undefined') return;
                    const now = dayjs();
                    const activeMessages = allMessages.filter(msg => {
                        const start = dayjs(msg.startDateTime);
                        const end = dayjs(msg.endDateTime);
                        return start.isValid() && end.isValid() && now.isAfter(start) && now.isBefore(end);
                    }).map(msg => msg.message);

                    const tickerBar = document.getElementById('ticker-bar');
                    const tickerContent = document.getElementById('ticker-content');
                    
                    if (activeMessages.length > 0) {
                        const fullText = activeMessages.join('   +++   ');
                        tickerContent.textContent = fullText;
                        if (!tickerContent.classList.contains('animate-marquee')) tickerContent.classList.add('animate-marquee');

                        const estimatedTextWidth = fullText.length * 25; 
                        const totalDistance = window.innerWidth + estimatedTextWidth;
                        const duration = totalDistance / 150; // Speed control

                        tickerContent.style.animationDuration = `${duration}s`;
                        tickerBar.classList.remove('hidden');
                        tickerBar.classList.add('flex');
                    } else {
                        tickerBar.classList.add('hidden');
                        tickerBar.classList.remove('flex');
                        tickerContent.classList.remove('animate-marquee');
                    }
                };
                checkTicker();
                if (tickerInterval) clearInterval(tickerInterval);
                tickerInterval = setInterval(checkTicker, 60000); 
            });
        }

        // ------------------------------
        // Audio
        // ------------------------------
        let audioEnabled = true; 
        const alertAudioElement = document.getElementById('alertSound');
        const toneFileMap = { 'default': 'sounds/default.mp3', 'alarm': 'sounds/alarm.mp3', 'chime': 'sounds/chime.mp3', 'ascending': 'sounds/ascending.mp3' };

        function playAlertSound(toneName = 'default') {
            if (!audioEnabled) return;
            const fileName = toneFileMap[toneName] || `sounds/${toneName}`;
            alertAudioElement.src = fileName;
            alertAudioElement.play().catch(error => console.warn(`Error playing sound "${fileName}":`, error));
        }

        // ------------------------------
        // News Feed Logic
        // ------------------------------
        async function fetchNewsFeed() {
            if (!dashboardConfig || typeof Papa === 'undefined') return;
            
            Papa.parse(SHEET_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    try {
                        const activePosts = filterActivePosts(results.data);
                        newsFeedPosts = activePosts; 
                        const secondsPerItem = dashboardConfig.newsFeed_secondsPerItem || 20;
                        const totalDurationMs = activePosts.length * secondsPerItem * 1000;
                        newsFeedSlideSource.duration = totalDurationMs > 0 ? totalDurationMs : 60000; 
                    } catch (error) {
                        newsFeedPosts = []; newsFeedSlideSource.duration = 60000; 
                    }
                }
            });
        }
        
        function filterActivePosts(posts) {
            if (typeof dayjs === 'undefined') return [];
            const now = dayjs();
            return posts.filter((post) => {
                const title = post['Title *'];
                const postDateStr = post['Date/Time to Post'];
                const removeDateStr = post['Date to Remove'];
                if (!title || !postDateStr) return false;
                const postDate = dayjs(postDateStr);
                if (!postDate.isValid() || !now.isAfter(postDate)) return false;
                if (removeDateStr) {
                    const removeDate = dayjs(removeDateStr);
                    if (removeDate.isValid() && now.isAfter(removeDate)) return false;
                }
                return true;
            });
        }

        function renderFeed(posts, feedContainer) {
            if (newsFeedSlideInterval) clearInterval(newsFeedSlideInterval);
            if (!feedContainer) return;
            const feedTrack = feedContainer.querySelector('#feed-track');
            if (!feedTrack) return;
            feedTrack.innerHTML = ''; 

            if (posts.length === 0) {
                feedContainer.innerHTML = `<div class="w-full h-full flex flex-col justify-center items-center text-center p-10"><h1 class="text-6xl text-gray-500 font-light">No Active Announcements</h1></div>`;
                return;
            }

            let itemsHtml = '';
            posts.forEach(post => {
                itemsHtml += `
                    <div class="feed-item w-full h-full absolute top-0 left-0 flex flex-col justify-center items-start p-24 sm:p-32 md:p-48">
                        <div class="w-24 h-2 bg-cyan-400 mb-8 rounded-full"></div>
                        <h1 class="text-7xl lg:text-8xl font-bold mb-6 text-white" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.2);">${post['Title *']}</h1>
                        <p class="text-3xl lg:text-4xl mb-12 text-gray-200 max-w-6xl font-light">${post['Description']}</p>
                        <div class="mt-8 pt-8 border-t border-gray-700 flex flex-wrap gap-x-10 gap-y-6 text-2xl text-gray-400">
                            ${post['Location'] ? `<span>Loc: ${post['Location']}</span>` : ''}
                            ${post['Applies To'] ? `<span>To: ${post['Applies To']}</span>` : ''}
                            ${post['Posted by'] ? `<span>From: ${post['Posted by']}</span>` : ''}
                        </div>
                    </div>`;
            });

            feedTrack.innerHTML = itemsHtml;
            startSlideshow(posts.length, feedTrack); 
        }

        function startSlideshow(postCount, feedTrack) {
            const slides = feedTrack.querySelectorAll('.feed-item');
            if (slides.length === 0) return;
            if (newsFeedSlideInterval) clearInterval(newsFeedSlideInterval); 
            let currentSlideIndex = 0;
            slides[currentSlideIndex].classList.add('active'); 
            slides[currentSlideIndex].classList.remove('fading-out'); 
            if (postCount <= 1) return; 

            let slideIndex = 0; 
            const secondsPerItem = (dashboardConfig && dashboardConfig.newsFeed_secondsPerItem) ? dashboardConfig.newsFeed_secondsPerItem : 20;

            newsFeedSlideInterval = setInterval(() => {
                if (slideIndex < postCount - 1) {
                    slides[slideIndex].classList.add('fading-out'); 
                    slides[slideIndex].classList.remove('active'); 
                    slideIndex++;
                    slides[slideIndex].classList.add('active'); 
                    slides[slideIndex].classList.remove('fading-out'); 
                } else {
                    clearInterval(newsFeedSlideInterval);
                    newsFeedSlideInterval = null;
                }
            }, secondsPerItem * 1000);
        }

        // ------------------------------
        // Slide Rotation
        // ------------------------------
        async function setupGoogleSlides() {
            if (!dashboardConfig) return;
            const slidesConfig = dashboardConfig; 
            const slidesSource = slideSources.find(s => s.type === 'googleslides');

            if (!slidesConfig.googleSlides_scriptUrl || !slidesSource) return;

            try {
                const response = await fetch(slidesConfig.googleSlides_scriptUrl, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                const slideCount = parseInt(await response.text(), 10);
                if (isNaN(slideCount) || slideCount <= 0) throw new Error('Invalid count');

                const delayMs = slidesConfig.googleSlides_delayPerSlideSeconds * 1000;
                slidesSource.duration = (delayMs <= 0) ? 20000 : slideCount * delayMs;
                const embedUrl = `${slidesConfig.googleSlides_embedUrlBase}&delayms=${delayMs}`;
                slidesSource.iframe = `<iframe title="Google Slides" src="${embedUrl}" frameborder="0" class="w-full h-full"></iframe>`;
            } catch (error) {
                if(slidesSource) {
                    slidesSource.iframe = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-red-400 p-8 text-center text-2xl">Error loading Google Slides: ${error.message}</div>`;
                    slidesSource.duration = 20000;
                }
            }
        }

        function scheduleNextSlide(duration) { 
            if (slideRotationTimer) clearTimeout(slideRotationTimer);
            slideRotationTimer = setTimeout(() => { 
                contentIndex = (contentIndex + 1) % slideSources.length; 
                rotateSlides(); 
            }, duration); 
        }

        function rotateSlides() {
            if (slideSources.length === 0) return;
            if (contentIndex >= slideSources.length) contentIndex = 0;

            let source = slideSources[contentIndex];
            const initialIndex = contentIndex;
            
            while (source.duration === 0) {
                contentIndex = (contentIndex + 1) % slideSources.length;
                source = slideSources[contentIndex];
                if (contentIndex === initialIndex) return; 
            }

            const nextSlideIndex = 1 - activeSlideIndex;
            const currentSlide = slideDivs[activeSlideIndex];
            const nextSlide = slideDivs[nextSlideIndex];
            nextSlide.innerHTML = source.iframe;

            if (source.type === 'newsfeed') {
                if (newsFeedSlideInterval) clearInterval(newsFeedSlideInterval); 
                const feedContainer = nextSlide.querySelector('#feed-container');
                if (feedContainer) renderFeed(newsFeedPosts, feedContainer); 
            } else if (newsFeedSlideInterval) {
                clearInterval(newsFeedSlideInterval);
                newsFeedSlideInterval = null;
            }

            const iframe = nextSlide.querySelector('iframe');
            const transition = () => {
                if (nextSlide.classList.contains('opacity-100')) return;
                currentSlide.classList.remove('opacity-100');
                currentSlide.classList.add('opacity-0');
                nextSlide.classList.remove('opacity-0');
                nextSlide.classList.add('opacity-100');
                activeSlideIndex = nextSlideIndex;
                scheduleNextSlide(source.duration);
            };

            if (iframe) {
                let loaded = false;
                const loadTimeout = setTimeout(() => { if (!loaded) transition(); }, 5000); 
                iframe.onload = () => { loaded = true; clearTimeout(loadTimeout); transition(); };
                iframe.onerror = () => { loaded = true; clearTimeout(loadTimeout); transition(); };
            } else {
                transition();
            }
        }

        async function startRotation() {
            if (slideRotationTimer) clearTimeout(slideRotationTimer);
            await setupGoogleSlides(); 
            
            if (slideSources.length === 0) {
                slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-yellow-300 p-8 text-center text-2xl">No slides configured.</div>`;
                slideDivs[0].classList.add('opacity-100');
                return;
            }

            contentIndex = 0;
            let firstSource = slideSources[contentIndex];
            while (firstSource.duration === 0) {
                contentIndex = (contentIndex + 1) % slideSources.length;
                firstSource = slideSources[contentIndex];
                if (contentIndex === 0 && firstSource.duration === 0) return;
            }
            
            slideDivs[0].innerHTML = firstSource.iframe;
            if (firstSource.type === 'newsfeed') {
                const feedContainer = slideDivs[0].querySelector('#feed-container');
                if (feedContainer) renderFeed(newsFeedPosts, feedContainer);
            }

            slideDivs[1].innerHTML = '';
            slideDivs[1].classList.add('opacity-0');
            
            const transition = () => {
                if (slideDivs[0].classList.contains('opacity-100')) return;
                slideDivs[0].classList.remove('opacity-0');
                slideDivs[0].classList.add('opacity-100');
                activeSlideIndex = 0;
                scheduleNextSlide(firstSource.duration);
            };
            
            const firstIframe = slideDivs[0].querySelector('iframe');
            if(firstIframe) {
                firstIframe.onload = () => transition();
                setTimeout(() => transition(), 5000);
            } else {
                transition();
            }
        }

        // ------------------------------
        // Alerts
        // ------------------------------
        function showIPAWSAlert(message, duration, toneName = 'default') {
          const overlay = document.getElementById("ipawsAlertOverlay");
          overlay.innerHTML = message;
          overlay.classList.remove('invisible', 'opacity-0');
          overlay.classList.add('opacity-100');
          playAlertSound(toneName);
          setTimeout(() => {
            overlay.classList.remove('opacity-100');
            overlay.classList.add('invisible', 'opacity-0');
          }, duration);
        }

        async function fetchIPAWSAlerts() {
          if (!dashboardConfig || !dashboardConfig.nwsAlertZone) return;
          try {
            const response = await fetch(`https://api.weather.gov/alerts/active/zone/${dashboardConfig.nwsAlertZone}`, {
                headers: { 'Accept': 'application/geo+json', 'User-Agent': '(PTFD Dashboard)' }
            });
            if (!response.ok) return;
            const data = await response.json();
            
            const sidebarAlert = document.getElementById('sidebar-alert-display');
            if (sidebarAlert) {
                if (data.features && data.features.length > 0) {
                    const events = [...new Set(data.features.map(f => f.properties.event))].join('<br>');
                    sidebarAlert.innerHTML = `<div class="bg-red-600 text-white rounded-lg p-3 animate-pulse border-2 border-red-400 shadow-lg text-center"><p class="text-sm font-black uppercase tracking-wide leading-tight">${events}</p></div>`;
                    sidebarAlert.classList.remove('hidden');
                } else {
                    sidebarAlert.classList.add('hidden');
                }
            }

            const newAlertMessages = [];
            if (data.features) {
              for (const feature of data.features) {
                if (!shownAlerts.has(feature.id)) {
                  newAlertMessages.push(feature.properties.headline);
                  shownAlerts.add(feature.id);
                }
              }
            }
            if (newAlertMessages.length > 0) {
              showIPAWSAlert(newAlertMessages.join(' ||| '), 60000 * newAlertMessages.length, 'alarm');
            }
          } catch (err) { console.error("IPAWS alert fetch failed:", err); }
        }
        
        // ------------------------------
        // Weather
        // ------------------------------
        const WEATHER_ICONS = {
            'Sunny': `<svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="#FBBF24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
            'Cloudy': `<svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>`
        };
        function getWeatherIcon(desc) {
            if (!desc) return WEATHER_ICONS['Cloudy'];
            const d = desc.toLowerCase();
            if (d.includes('sunny') || d.includes('clear')) return WEATHER_ICONS['Sunny'];
            return WEATHER_ICONS['Cloudy'];
        }

        async function fetchToolbarWeather() {
            if (!dashboardConfig || !dashboardConfig.weather_latitude) return;
            try {
                const pointsUrl = `https://api.weather.gov/points/${dashboardConfig.weather_latitude},${dashboardConfig.weather_longitude}`;
                const pointsResponse = await fetch(pointsUrl, { headers: { 'User-Agent': '(PTFD Dashboard)' } });
                const pointsData = await pointsResponse.json();
                
                const [forecastResponse, hourlyResponse] = await Promise.all([
                    fetch(pointsData.properties.forecast),
                    fetch(pointsData.properties.forecastHourly)
                ]);

                const forecastData = await forecastResponse.json();
                const hourlyData = await hourlyResponse.json();
                const currentPeriod = hourlyData.properties.periods[0];
                
                document.getElementById('weather-temp').textContent = `${currentPeriod.temperature}°`;
                document.getElementById('weather-condition').textContent = currentPeriod.shortForecast;
                document.getElementById('weather-location').textContent = pointsData.properties.relativeLocation.properties.city;
                document.getElementById('weather-icon-container').innerHTML = getWeatherIcon(currentPeriod.shortForecast);
                
                let high = '--', low = '--';
                if (forecastData.properties.periods.length > 1) {
                    const startIdx = forecastData.properties.periods[0].isDaytime ? 0 : 1;
                    high = forecastData.properties.periods[startIdx].temperature;
                    low = forecastData.properties.periods[startIdx+1]?.temperature || '--';
                }
                document.getElementById('weather-high-low').textContent = `H: ${high}° L: ${low}°`;

            } catch (error) { console.error("Weather fetch failed:", error); }
        }

        // ------------------------------
        // Firebase Listeners
        // ------------------------------
        function initializeConfigListener() {
            // *** PATH UPDATED ***
            const configDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'config', 'global');
            let firstConfigLoad = true; 

            onSnapshot(configDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    dashboardConfig = docSnap.data();
                    const logoImg = document.getElementById('dashboard-logo');
                    logoImg.style.display = dashboardConfig.logoUrl ? 'block' : 'none';
                    if (dashboardConfig.logoUrl) logoImg.src = dashboardConfig.logoUrl;

                    if (ipawsInterval) clearInterval(ipawsInterval);
                    if (weatherInterval) clearInterval(weatherInterval);
                    if (slidesRefreshInterval) clearInterval(slidesRefreshInterval);

                    fetchIPAWSAlerts();
                    fetchToolbarWeather();
                    
                    if (firstConfigLoad) {
                        initializeAlertListener(); 
                        initializeSlideListener(); 
                        initializeForceReloadListener(); 
                        initializeTicker(); 
                        fetchNewsFeed(); 
                        setInterval(fetchNewsFeed, REFRESH_INTERVAL_MS); 
                        firstConfigLoad = false;
                    } else {
                        await setupGoogleSlides();
                        fetchNewsFeed(); 
                    }

                    ipawsInterval = setInterval(fetchIPAWSAlerts, (dashboardConfig.nwsAlertRefreshSeconds || 300) * 1000);
                    weatherInterval = setInterval(fetchToolbarWeather, Math.max(dashboardConfig.weather_refreshIntervalMinutes || 10, 1) * 60 * 1000);
                    if (dashboardConfig.googleSlides_refreshIntervalMinutes > 0) {
                        slidesRefreshInterval = setInterval(async () => await setupGoogleSlides(), dashboardConfig.googleSlides_refreshIntervalMinutes * 60 * 1000);
                    }
                }
            });
        }

        function initializeAlertListener() {
            // *** PATH UPDATED ***
            const alertDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'alerts', 'manual_alert');
            let isDeleting = false; 

            onSnapshot(alertDocRef, (docSnap) => {
                if (docSnap.exists() && !isDeleting) { 
                    isDeleting = true; 
                    const data = docSnap.data();
                    if (data && data.message) {
                         const msg = data.title ? `<div class="text-center"><h1 class="text-6xl font-black mb-4">${data.title}</h1><p class="text-4xl font-bold">${data.message}</p></div>` : data.message;
                         showIPAWSAlert(msg, data.duration, data.tone);
                         deleteDoc(alertDocRef).catch(e => console.error(e)).finally(() => isDeleting = false);
                    } else {
                        isDeleting = false;
                    }
                } else if (!docSnap.exists()) isDeleting = false;
            });
        }

        function initializeForceReloadListener() {
            // *** PATH UPDATED ***
            const forceReloadDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'alerts', 'force_reload');
            onSnapshot(forceReloadDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    deleteDoc(forceReloadDocRef).finally(() => window.location.reload(true));
                }
            });
        }

        function initializeSlideListener() {
            // *** PATH UPDATED ***
            const slidesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'slides');
            const slidesQuery = query(slidesRef, orderBy('order'));
            
            onSnapshot(slidesQuery, (snapshot) => {
                const newSlideSources = [googleSlideSource, newsFeedSlideSource]; 
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.iframe && data.duration > 0) newSlideSources.push(data);
                });
                newSlideSources.sort((a, b) => (a.order || 99) - (b.order || 99));
                slideSources = newSlideSources; 
                startRotation(); 
            }, (error) => {
                slideSources = [googleSlideSource, newsFeedSlideSource].sort((a, b) => a.order - b.order);
                startRotation();
            });
        }
        
        // ------------------------------
        // Initialization
        // ------------------------------
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // *** CRITICAL: ANONYMOUS AUTH ***
            // Rules require auth. Dashboard must sign in.
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Dashboard authenticated anonymously.");
                    initializeConfigListener();
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Dashboard failed to sign in anonymously:", error);
                        // Display error on screen
                        slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-red-900 text-white p-8 text-center text-3xl"><strong>Auth Error:</strong><br>${error.message}</div>`;
                        slideDivs[0].classList.add('opacity-100');
                    });
                }
            });
        } catch(e) {
            console.error("Failed to initialize Firebase:", e);
        }
        
        feather.replace(); 
    });
  </script>
</body>
</html>
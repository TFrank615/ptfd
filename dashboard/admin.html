<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Console</title>
    <link rel="icon" type="image/x-icon" href="./assets/256.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .tab-panel { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen p-8">

    <!-- Login -->
    <div id="login-wrapper" class="max-w-md mx-auto bg-white shadow-md rounded-lg p-8 mt-20">
        <h2 class="text-3xl font-black text-center text-gray-800 mb-6">Admin Login</h2>
        <form id="login-form">
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="login-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
            </div>
            <div class="mt-4">
                <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="login-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black">
            </div>
            <div class="mt-6">
                <button type="submit" class="w-full inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700">Sign In</button>
            </div>
            <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
        </form>
    </div>

    <!-- Admin Content -->
    <div id="admin-wrapper" class="max-w-6xl mx-auto hidden">
        <div class="flex justify-between items-center mb-6 flex-wrap">
            <div>
                <h1 class="text-4xl font-black text-gray-800">PTFD Dashboard Admin</h1>
                <p id="user-email-display" class="text-sm text-gray-600 mt-1"></p>
            </div>
            <div class="flex gap-4 mt-4 md:mt-0">
                <button id="manual-refresh-btn" class="inline-flex justify-center rounded-lg border border-transparent bg-green-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-green-700">Refresh Dashboard</button>
                <button id="force-reload-btn" class="inline-flex justify-center rounded-lg border border-transparent bg-red-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-red-700">Force Reload All</button>
                <button id="sign-out-btn" class="inline-flex justify-center rounded-lg border border-gray-300 bg-white py-2 px-6 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50">Sign Out</button>
            </div>
        </div>

        <div id="global-error-panel" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold">Error</p>
            <p id="global-error-message"></p>
        </div>

        <nav class="mb-6">
            <ul class="flex border-b border-gray-300">
                <li><button data-tab="weather" class="nav-tab py-2 px-4 font-medium">Weather</button></li>
                <li><button data-tab="logo" class="nav-tab py-2 px-4 font-medium">Logo</button></li>
                <li><button data-tab="gslides" class="nav-tab py-2 px-4 font-medium">Google Slides</button></li>
                <li><button data-tab="news" class="nav-tab py-2 px-4 font-medium">News Feed</button></li>
                <li><button data-tab="nws" class="nav-tab py-2 px-4 font-medium">Alerts</button></li>
                <li><button data-tab="slide-management" class="nav-tab py-2 px-4 font-medium">Slide Management</button></li>
            </ul>
        </nav>

        <div id="tab-content">
            <div id="config-container" class="bg-white p-6 rounded-lg shadow-md mb-8">
                <div id="config-loading-spinner" class="text-center p-8">Loading Settings...</div>

                <form id="config-form" class="hidden">
                    <!-- Weather -->
                    <div id="tab-weather" class="tab-panel">
                        <fieldset class="border-t border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Weather Widget</legend>
                            <div class="form-grid mt-4">
                                <div><label class="block text-sm font-medium text-gray-700">Location Name</label><input type="text" id="weather_locationName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Latitude</label><input type="number" step="any" id="weather_latitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Longitude</label><input type="number" step="any" id="weather_longitude" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Refresh (min)</label><input type="number" id="weather_refreshIntervalMinutes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                            </div>
                        </fieldset>
                    </div>
                    <!-- Logo -->
                    <div id="tab-logo" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Logo</legend>
                            <div class="mt-4"><label class="block text-sm font-medium text-gray-700">ImgBB API Key</label><input type="text" id="imgbb_api_key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                            <div class="mt-4"><input type="file" id="logo_upload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500">
                                <button type="button" id="upload-logo-btn" class="mt-3 inline-flex justify-center rounded-lg border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">Upload & Save</button>
                                <span id="upload-feedback" class="ml-4 text-gray-600"></span>
                            </div>
                            <div class="mt-4"><img id="logo-preview" class="mt-2 h-24 w-auto rounded bg-gray-50"><input type="hidden" id="logo_url"></div>
                        </fieldset>
                    </div>
                    <!-- Google Slides -->
                    <div id="tab-gslides" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Google Slides</legend>
                            <div class="form-grid mt-4">
                                <div class="col-span-2"><label class="block text-sm font-medium text-gray-700">Apps Script URL</label><input type="url" id="googleSlides_scriptUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                                <div class="col-span-2"><label class="block text-sm font-medium text-gray-700">Embed URL Base</label><input type="url" id="googleSlides_embedUrlBase" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Delay per Slide (s)</label><input type="number" id="googleSlides_delayPerSlideSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Refresh (min)</label><input type="number" id="googleSlides_refreshIntervalMinutes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                            </div>
                        </fieldset>
                    </div>
                    <!-- News -->
                    <div id="tab-news" class="tab-panel">
                         <fieldset class="border-b border-gray-200 py-6"><legend class="text-lg font-medium text-gray-900">News Feed</legend><div class="mt-4"><div><label class="block text-sm font-medium text-gray-700">Seconds Per Item</label><input type="number" id="newsFeed_secondsPerItem" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div></div></fieldset>
                    </div>
                    <!-- Alerts -->
                    <div id="tab-nws" class="tab-panel">
                        <fieldset class="border-b border-gray-200 py-6">
                            <legend class="text-lg font-medium text-gray-900">Alerts</legend>
                            <div class="form-grid mt-4">
                                <div><label class="block text-sm font-medium text-gray-700">NWS Zone</label><input type="text" id="nwsAlertZone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Refresh (s)</label><input type="number" id="nwsAlertRefreshSeconds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                            </div>
                            <div class="mt-6"><button type="button" id="test-manual-alert-btn" class="mt-3 inline-flex justify-center rounded-lg border border-transparent bg-yellow-500 py-2 px-4 text-sm font-medium text-black shadow-sm">Send Test Alert</button><span id="test-manual-feedback" class="ml-4 text-gray-600"></span></div>
                        </fieldset>
                    </div>
                    <!-- Save -->
                    <div class="flex justify-end mt-6"><button type="submit" class="inline-flex justify-center rounded-lg border border-transparent bg-blue-600 py-2 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700">Save Settings</button><span id="save-feedback" class="ml-4 text-green-600 font-medium items-center hidden">Saved!</span></div>
                </form>
            </div>

            <!-- Slides -->
            <div id="tab-slide-management" class="tab-panel">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h2 class="text-2xl font-bold mb-4">Add Slide</h2>
                    <form id="add-slide-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">URL</label><input type="text" id="slide-url" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Title</label><input type="text" id="slide-title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Duration (s)</label><input type="number" id="slide-duration" value="20" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Order</label><input type="number" id="slide-order" value="10" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black"></div>
                        <div class="md:col-span-3 flex justify-end"><button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-lg">Add Slide</button></div>
                    </form>
                </div>
                <div><h2 class="text-2xl font-bold mb-4">Current Slides</h2><div id="loading-spinner" class="text-center">Loading...</div><div id="slides-list" class="space-y-4"></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

        // --- UPDATED FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyAEELEzdEeTgidrSjThsTH2-uDPnFindb0",
          authDomain: "pleasant-township-48aa9.firebaseapp.com",
          projectId: "pleasant-township-48aa9",
          storageBucket: "pleasant-township-48aa9.firebasestorage.app",
          messagingSenderId: "859989513428",
          appId: "1:859989513428:web:097a276b3ed90d80e35741",
          measurementId: "G-V3HNW1E3S4"
        };
        
        // --- PATH HELPER ---
        const APP_ID = firebaseConfig.appId;
        const getPath = (colName) => `artifacts/${APP_ID}/public/data/${colName}`;
        const getDocPath = (colName, docId) => `artifacts/${APP_ID}/public/data/${colName}/${docId}`;

        let db, auth;
        let slidesCollection, configDocRef, manualAlertDocRef, forceReloadDocRef;

        const loginWrapper = document.getElementById('login-wrapper');
        const adminWrapper = document.getElementById('admin-wrapper');
        const slidesList = document.getElementById('slides-list');

        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // *** UPDATED PATHS ***
                slidesCollection = collection(db, 'artifacts', APP_ID, 'public', 'data', 'slides');
                configDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'config', 'global');
                manualAlertDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'alerts', 'manual_alert');
                forceReloadDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'alerts', 'force_reload');
                return true;
            } catch(e) { console.error("Init Error", e); return false; }
        }

        async function loadConfig() {
            try {
                const docSnap = await getDoc(configDocRef);
                const config = docSnap.exists() ? docSnap.data() : {};
                
                ['weather_locationName', 'weather_latitude', 'weather_longitude', 'weather_refreshIntervalMinutes', 'googleSlides_scriptUrl', 'googleSlides_embedUrlBase', 'googleSlides_delayPerSlideSeconds', 'googleSlides_refreshIntervalMinutes', 'newsFeed_secondsPerItem', 'nwsAlertZone', 'nwsAlertRefreshSeconds', 'logo_url'].forEach(key => {
                     const el = document.getElementById(key);
                     if(el) el.value = config[key] || '';
                });
                
                if(config.logoUrl) document.getElementById('logo-preview').src = config.logoUrl;
                document.getElementById('config-loading-spinner').style.display = 'none';
                document.getElementById('config-form').classList.remove('hidden');
            } catch (error) { console.error(error); }
        }

        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {};
            Array.from(e.target.elements).forEach(el => {
                if(el.id && el.type !== 'submit' && el.type !== 'button') {
                    data[el.id] = el.type === 'number' ? parseFloat(el.value) : el.value;
                }
            });
            await setDoc(configDocRef, data, { merge: true });
            const fb = document.getElementById('save-feedback');
            fb.classList.remove('hidden'); fb.classList.add('flex');
            setTimeout(() => fb.classList.add('hidden'), 2000);
        });

        function renderSlides(docs) {
            document.getElementById('loading-spinner').style.display = 'none';
            slidesList.innerHTML = '';
            docs.forEach(doc => {
                const s = doc.data();
                const d = document.createElement('div');
                d.className = 'bg-white p-4 rounded-lg shadow grid grid-cols-1 md:grid-cols-4 gap-4 items-center';
                d.dataset.id = doc.id;
                d.innerHTML = `
                    <div class="md:col-span-2"><p class="font-bold text-blue-700">${s.type === 'iframe' ? 'Web Slide' : 'Slide'}</p><p class="text-xs text-gray-500 truncate">${s.iframe}</p></div>
                    <div><input type="number" value="${s.duration/1000}" class="border rounded p-1 w-20 duration">s</div>
                    <div><input type="number" value="${s.order}" class="border rounded p-1 w-16 order"></div>
                    <div class="flex gap-2"><button class="bg-green-600 text-white px-3 py-1 rounded save">Save</button><button class="bg-red-50 text-red-600 px-3 py-1 rounded delete">Delete</button></div>
                `;
                slidesList.appendChild(d);
            });
        }

        function listenToSlides() {
            onSnapshot(query(slidesCollection, orderBy('order')), (snap) => renderSlides(snap.docs));
        }

        document.getElementById('add-slide-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('slide-url').value;
            const title = document.getElementById('slide-title').value;
            const iframe = `<iframe title="${title}" src="${url}" frameborder="0" class="w-full h-full"></iframe>`;
            await addDoc(slidesCollection, { 
                type: 'iframe', iframe, 
                duration: document.getElementById('slide-duration').value * 1000,
                order: parseInt(document.getElementById('slide-order').value)
            });
            e.target.reset();
        });

        slidesList.addEventListener('click', async (e) => {
            const el = e.target.closest('[data-id]');
            if(!el) return;
            const ref = doc(slidesCollection, el.dataset.id);
            
            if(e.target.classList.contains('delete') && confirm('Delete?')) await deleteDoc(ref);
            if(e.target.classList.contains('save')) {
                await updateDoc(ref, { 
                    duration: el.querySelector('.duration').value * 1000, 
                    order: parseInt(el.querySelector('.order').value) 
                });
                e.target.textContent = 'Saved!'; setTimeout(() => e.target.textContent='Save', 1000);
            }
        });

        // Tab Logic
        document.querySelectorAll('.nav-tab').forEach(t => {
            t.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-tab').forEach(x => x.classList.replace('text-blue-600', 'text-gray-500'));
                document.querySelectorAll('.nav-tab').forEach(x => x.classList.replace('border-blue-600', 'border-transparent'));
                e.target.classList.replace('text-gray-500', 'text-blue-600');
                e.target.classList.replace('border-transparent', 'border-blue-600');
                
                document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
                document.getElementById('tab-'+e.target.dataset.tab).style.display = 'block';
                document.getElementById('config-container').style.display = e.target.dataset.tab === 'slide-management' ? 'none' : 'block';
            });
        });
        document.querySelector('[data-tab="weather"]').click();

        // Buttons
        document.getElementById('manual-refresh-btn').addEventListener('click', async () => {
             await setDoc(configDocRef, { lastUpdated: new Date().toISOString() }, { merge: true });
        });
        document.getElementById('test-manual-alert-btn').addEventListener('click', async () => {
             await setDoc(manualAlertDocRef, { title: "TEST", message: "This is a test.", duration: 15000, tone: "chime", timestamp: new Date().toISOString() });
        });
        document.getElementById('force-reload-btn').addEventListener('click', async () => {
             if(confirm('Reload all dashboards?')) await setDoc(forceReloadDocRef, { timestamp: new Date().toISOString() });
        });
        document.getElementById('upload-logo-btn').addEventListener('click', async () => {
            const file = document.getElementById('logo_upload').files[0];
            const key = document.getElementById('imgbb_api_key').value;
            if(!file || !key) return;
            const fd = new FormData(); fd.append('image', file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${key}`, { method:'POST', body:fd });
            const json = await res.json();
            if(json.success) {
                document.getElementById('logo_url').value = json.data.display_url;
                document.getElementById('logo-preview').src = json.data.display_url;
                await setDoc(configDocRef, { logoUrl: json.data.display_url }, { merge: true });
            }
        });

        // Auth
        initializeFirebase();
        onAuthStateChanged(auth, (user) => {
            if(user) {
                loginWrapper.classList.add('hidden');
                adminWrapper.classList.remove('hidden');
                document.getElementById('user-email-display').textContent = user.email;
                loadConfig();
                listenToSlides();
            } else {
                loginWrapper.classList.remove('hidden');
                adminWrapper.classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value)
            .catch(e => document.getElementById('login-error').textContent = e.message);
        });
        document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));
    </script>
</body>
</html>